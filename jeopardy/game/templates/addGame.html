<head>
    <script type="text/javascript" src="/static/jquery.min.js">
    </script>

    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $(document).on("click", "#addCategory", function() {
            window.categories = [];
            var questions;
            $.ajax({
              type: 'GET',
              url: "/getQuestions/",
              data: {
                category: $("#categorySelect").val(),
              },
              success: function(data) {
                //console.log(data);
                questions = eval(data);
                //console.log(questions);
              },
              async:false
            });
            //console.log(questions);
            var questionObject = {};
            for (var i = 1; i <= 5; ++i) {
                questionObject[100 * i] = [];
            }
            for (var i = 0; i < questions.length; ++i) {
                var price = questions[i].fields.price;
                questionObject[price].push([questions[i].fields.statement, questions[i].pk]);
            }
            //console.log(questionObject);
            var response = "<div class='newCategory' style='border-style:solid' id=\"" + window.categories.length.toString() + "\">\n";
            window.categories.push($("#categorySelect").val());
            response += 
                "  \
                    <p> \
                " 
                + $("#categorySelect :selected").text() +  
                " \
                    </p>  \
                ";
            for (var i = 1; i <= 5; ++i) {
                response += "<br />" + (100 * i).toString() + "<br />";
                response += "<select name=\"" + (100 * i).toString() + "\">";
                for (var j = 0; j < questionObject[100 * i].length; ++j) {
                    response += "<option value=\"" + questionObject[100 * i][j][1].toString() + "\">";
                    response += questionObject[100 * i][j][0].toString();
                    response += "</option>";
                }
                response += "</select>";
            }
            response += "\n</div>\n";
            $("#categories").append(
                response        
            );
        });
        
        $(document).on("click", "#magic", function() {
            var gameId;
            $.ajax({
                type: 'POST',
                url: "/registerGame/",
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                },
                success: function(data) {
                    console.log(data);
                    gameId = data;
                },
                async:false
            });

            console.log(gameId);
            for (var i = 0; i < categories.length; ++i) {
                var result = {"category" : categories[i]};
                result["game"] = gameId;
                $("#" + i.toString()).children().each(function() {
                    if ($(this).prop("tagName") == "SELECT") {
                        //console.log($(this).attr("name"), $("option:selected", this).val());

                        result[parseInt($(this).attr("name"))] = $("option:selected", this).val();
                    }
                });
                $.ajax({
                    type: 'POST',
                    url: "/addCategoryToGame/",
                    beforeSend: function(xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    },
                    data : result,
                    success: function(data) {
                        console.log(data);
                        gameId = data;
                    },
                    async: true
                });
            }
            alert("Success");
            window.location.replace('/');
        });
    </script>
</head>


<a href="/">
    Home
</a>

<form method="POST" action="/addGameProcess/">
    {% csrf_token %}
    <p>
        Create a Game
    </p>
    <input type="button" value="Magic" id="magic" />
    <div id="categories">
        <select id="categorySelect">
            {% for category in categories %}
                <option value="{{ category.id }}">
                    {{ category.title }}
                </option>
            {% endfor %}
        </select>
        <input type="button" id="addCategory" value="addCategory"/>
        <br />
        <br />
    </div>
    
</form>